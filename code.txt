# main() will be run when you invoke this action
#
# @param Cloud Functions actions accept a single parameter, which must be a JSON object.
#
# @return The output of this action, which must be a JSON object.
#

import sys
import json
import requests

def main(dic):
    # NOTE: you must manually set API_KEY below using information retrieved from your IBM Cloud account.
    API_KEY = dic["api_key"]
    token_response = requests.post('https://iam.cloud.ibm.com/identity/token', data={"apikey": API_KEY, "grant_type": 'urn:ibm:params:oauth:grant-type:apikey'})
    mltoken = token_response.json()["access_token"]
    
    header = {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + mltoken}
    
    # NOTE: manually define and pass the array(s) of values to be scored in the next line
    payload_scoring = {
	"input_data": [
		{
			"fields": [
				"LoanDuration",
				"LoanPurpose",
				"LoanAmount",
				"ExistingSavings",
				"EmploymentDuration",
				"InstallmentPercent",
				"OthersOnLoan",
				"CurrentResidenceDuration",
				"OwnsProperty",
				"Age",
				"InstallmentPlans",
				"Housing",
				"ExistingCreditsCount",
				"Job"
			],
			"values": [
				[
					dic["LoanDuration"],
					dic["LoanPurpose"],
					dic["LoanAmount"],
					dic["ExistingSavings"],
					dic["EmploymentDuration"],
					dic["InstallmentPercent"],
					dic["OthersOnLoan"],
					dic["CurrentResidenceDuration"],
					dic["OwnsProperty"],
					dic["Age"],
					dic["InstallmentPlans"],
					dic["Housing"],
					dic["ExistingCreditsCount"],
					dic["Job"]

				]
			]
		}
	]
}
    response_scoring = requests.post('Add your machine learning deployment URL', json=payload_scoring, headers={'Authorization': 'Bearer ' + mltoken})
    print("Scoring response")
    print(response_scoring.json())
    result = response_scoring.text
    result_json = json.loads(result)

    result_keys = result_json['predictions'][0]['fields']
    result_vals = result_json['predictions'][0]['values']
   
    result_dict = dict(zip(result_keys, result_vals[0]))
  
    no_percent = result_dict["probability"][0] * 100
    print("no_percent: ", no_percent)
    yes_percent = result_dict["probability"][1] * 100
    print("yes_percent: ", yes_percent)
    
    predict = result_dict["prediction"]
    
  
    
    final = ('Your application is presenting a ' + predict + ' application with a risk probability of: %.0f%%'% yes_percent)
    print("final: ", final)
    return { 'message': final }
    